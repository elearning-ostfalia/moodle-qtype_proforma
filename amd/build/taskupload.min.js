define("qtype_proforma/taskupload",["exports","core/config","core/modal_factory","core/modal_events","core/str"],(function(_exports,_config,_modal_factory,_modal_events,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.upload=void 0,_config=_interopRequireDefault(_config),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events);_exports.upload=function(buttonid,task){var source=null,modalroot=null,closeString="close";function _init(){return(_init=_asyncToGenerator(regeneratorRuntime.mark((function _callee(){return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,(0,_str.get_string)("close","editor");case 2:closeString=_context.sent;case 3:case"end":return _context.stop()}}),_callee)})))).apply(this,arguments)}function _uploadWithSse(){return(_uploadWithSse=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(){var questionId,url;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:questionId=document.querySelector("input[name='id']").value,url=_config.default.wwwroot+"/question/type/proforma/upload_sse.php",url+="?sesskey="+_config.default.sesskey+"&id="+questionId,(source=new EventSource(url)).onmessage=function(event){var dialog=document.querySelector("#proforma-modal-message");if(null!=dialog){var message=event.data.trim();(message.startsWith("b'")||message.startsWith('b"'))&&(message="<b>"+message.substring(2,message.length-3)+"</b>"),dialog.innerHTML+=message+"<br>"}},source.onerror=function(event){source.close();var dialog=document.querySelector(".modal");if(dialog){var button=dialog.querySelector(".btn-secondary");button&&(button.innerHTML=closeString)}};case 6:case"end":return _context2.stop()}}),_callee2)})))).apply(this,arguments)}!function(){_init.apply(this,arguments)}(),document.getElementById(buttonid).addEventListener("click",(function(e){_modal_factory.default.create({type:_modal_factory.default.types.CANCEL,title:"Upload Log",body:'<span><code id ="proforma-modal-message"></code></span>',large:!0}).then((function(modal){(modalroot=modal.getRoot()).on(_modal_events.default.cancel,(function(){source.close(),source=null,modalroot.remove()})),modal.show(),function(){_uploadWithSse.apply(this,arguments)}()}))}))}}));

//# sourceMappingURL=taskupload.min.js.map