define("qtype_proforma/inlinemessages",["exports"],(function(_exports){function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}
/**
   * Display error messages inline in Codemirror editor.
   *
   * @package    qtype_proforma
   * @copyright  2021 Ostfalia Hochschule fuer angewandte Wissenschaften
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   * @author     K.Borm <k.borm[at]ostfalia.de>
   */function _hideWidgets(widgets){for(var i=0;i<widgets.length;++i)widgets[i].clear();return widgets.length=0,widgets}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.embedError=void 0;function _embedErrorWithDocumentLoaded(cmid,collapsregion,regexp,filename){var id,widgets=[];cmid=CSS.escape(cmid),(id=collapsregion,new Promise((function(resolve){!function wait(){var element=document.getElementById(id);element&&resolve(element),window.requestAnimationFrame(wait)}()}))).then((function(region){return node=region,selector="a",new Promise((function(resolve){!function wait(){var element=node.querySelector(selector);element&&resolve(element),window.requestAnimationFrame(wait)}()}));var node,selector})).then((function(a_element){var messages=function(collapsregion,regexp,editorfilename){var _step,messages=[],testlogs=document.getElementById(collapsregion).querySelectorAll(".proforma_testlog"),innertext="",re=new RegExp(regexp,"mg"),_iterator=_createForOfIteratorHelper(testlogs);try{for(_iterator.s();!(_step=_iterator.n()).done;){var testlog=_step.value,log=void 0;(log=0===testlog.innerText.length?testlog.textContent:testlog.innerText).match(re)&&(innertext=innertext.length>0?innertext+"\n"+log:log)}}catch(err){_iterator.e(err)}finally{_iterator.f()}var _step2,_iterator2=_createForOfIteratorHelper(innertext.matchAll(re));try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _result$groups=_step2.value.groups,msgtype=_result$groups.msgtype,filename=_result$groups.filename,line=_result$groups.line,text=_result$groups.text,symbol=_result$groups.symbol;if(void 0===filename||null==editorfilename||0===editorfilename.localeCompare(filename)){var error={line:line,text:text,msgtype:msgtype};void 0!==symbol&&(error.text=error.text+" '"+symbol.trim()+"'"),messages.push(error)}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return messages}(collapsregion,regexp,filename);if(0!=messages.length){var values=function(messages){var errors=0,warnings=0,infos=0,somethingelse=0;if(messages)for(var i=0;i<messages.length;++i){var msg=messages[i];if(msg)if(void 0!==msg.msgtype)switch(msg.msgtype.toLowerCase()){case"error":errors++;break;case"warn":case"warning":warnings++;break;case"info":infos++;break;default:console.error("do not know message type "+msg.msgtype),somethingelse++}else errors++}return[errors,warnings,infos,somethingelse]}(messages),errors=values[0],warnings=values[1],infos=values[2],somethingelse=values[3],label=" ";errors>0&&(label+=errors+'<span class="proforma-dot-icon proforma-error-icon">x</span> '),warnings>0&&(label+=warnings+'<span class="proforma-warn-icon proforma-warning"/></span> '),infos>0&&(label+=infos+'<span class="proforma-dot-icon proforma-info-icon">i</span> '),somethingelse>0&&(label+=somethingelse+'<span class="proforma-dot-icon proforma-else-icon">?</span> ');var button=document.createElement("button");button.type="button",button.className="proforma-feedback-msg-btn",button.innerHTML=label,a_element.insertAdjacentElement("afterend",button);var showMsg=!1;button.addEventListener("click",(function(){var editor=function(target){var _target=target;if("string"==typeof _target&&(_target=document.querySelector(_target)),null===_target||void 0===!_target.tagName)throw new Error("Element "+target+" does not reference a CodeMirror instance.");return"TEXTAREA"===_target.tagName?_target.nextSibling.CodeMirror:(console.error("could not find Codemirror editor for "+target),null)}("#"+cmid);showMsg?(widgets=_hideWidgets(widgets),button.className="proforma-feedback-msg-btn",showMsg=!1):(widgets=function(editor,errors,widgets){widgets=_hideWidgets(widgets);for(var i=0;i<errors.length;++i){var err=errors[i];if(err){var icon,msg=document.createElement("div");if(void 0!==err.msgtype)switch(err.msgtype.toLowerCase()){case"error":(icon=msg.appendChild(document.createElement("span"))).innerHTML="x",icon.className="proforma-dot-icon proforma-error-icon",msg.className="proforma-inline-error";break;case"warn":case"warning":(icon=msg.appendChild(document.createElement("span"))).className="proforma-warn-icon proforma-warning",msg.className="proforma-inline-warning";break;case"info":(icon=msg.appendChild(document.createElement("span"))).innerHTML="i",icon.className="proforma-dot-icon proforma-info-icon",msg.className="proforma-inline-info";break;default:(icon=msg.appendChild(document.createElement("span"))).innerHTML="?",icon.className="proforma-dot-icon proforma-else-icon",msg.className="proforma-inline-info",console.error("do not know message type "+err.msgtype)}else(icon=msg.appendChild(document.createElement("span"))).innerHTML="x",icon.className="proforma-dot-icon proforma-error-icon",msg.className="proforma-inline-error";msg.appendChild(document.createTextNode(" "+err.text));var widget=editor.addLineWidget(err.line-1,msg,{coverGutter:!0,noHScroll:!0});widgets.push(widget)}}var info=editor.getScrollInfo(),after=editor.charCoords({line:editor.getCursor().line+1,ch:0},"local").top;return info.top+info.clientHeight<after&&editor.scrollTo(null,after-info.clientHeight+3),widgets}(editor,messages,widgets),button.className="proforma-feedback-msg-btn active",showMsg=!0)}))}})).catch((function(error){console.error(error)}))}_exports.embedError=function(cmid,collapsregion,regexp,filename){cmid?"loading"!==document.readyState?_embedErrorWithDocumentLoaded(cmid,collapsregion,regexp,filename):document.addEventListener("DOMContentLoaded",(function(){_embedErrorWithDocumentLoaded(cmid,collapsregion,regexp,filename)})):console.error("cmid is invalid")}}));

//# sourceMappingURL=inlinemessages.min.js.map