function _hideWidgets(e){for(let o=0;o<e.length;++o)e[o].clear();return e.length=0,e}function _showMessages(e,o,r){r=_hideWidgets(r);for(let i=0;i<o.length;++i){let s=o[i];if(s){var n,t=document.createElement("div");if(void 0!==s.msgtype)switch(s.msgtype.toLowerCase()){case"error":(n=t.appendChild(document.createElement("span"))).innerHTML="x",n.className="proforma-dot-icon proforma-error-icon",t.className="proforma-inline-error";break;case"warn":case"warning":(n=t.appendChild(document.createElement("span"))).className="proforma-warn-icon proforma-warning",t.className="proforma-inline-warning";break;case"info":(n=t.appendChild(document.createElement("span"))).innerHTML="i",n.className="proforma-dot-icon proforma-info-icon",t.className="proforma-inline-info";break;default:(n=t.appendChild(document.createElement("span"))).innerHTML="?",n.className="proforma-dot-icon proforma-else-icon",t.className="proforma-inline-info",console.error("do not know message type "+s.msgtype)}else(n=t.appendChild(document.createElement("span"))).innerHTML="x",n.className="proforma-dot-icon proforma-error-icon",t.className="proforma-inline-error";t.appendChild(document.createTextNode(" "+s.text));var a=e.addLineWidget(s.line-1,t,{coverGutter:!0,noHScroll:!0});r.push(a)}}let i=e.getScrollInfo(),s=e.charCoords({line:e.getCursor().line+1,ch:0},"local").top;return i.top+i.clientHeight<s&&e.scrollTo(null,s-i.clientHeight+3),r}function _getCodeMirror(e){let o=e;if("string"==typeof o&&(o=document.querySelector(o)),null===o||void 0===!o.tagName)throw new Error("Element "+e+" does not reference a CodeMirror instance.");return"TEXTAREA"===o.tagName?o.nextSibling.CodeMirror:(console.error("could not find Codemirror editor for "+e),null)}function _getErrorsFromLog(e,o,r){let n=[],t=document.getElementById(e).querySelectorAll(".proforma_testlog"),a="",i=new RegExp(o,"mg");for(let e of t){let o=void 0;(o=0===e.innerText.length?e.textContent:e.innerText).match(i)&&(a=a.length>0?a+"\n"+o:o)}let s=a.matchAll(i);for(let e of s){let{msgtype:o,filename:t,line:a,text:i,symbol:s}=e.groups;if(void 0!==t&&null!=r&&0!==r.localeCompare(t))continue;let l={line:a,text:i,msgtype:o};void 0!==s&&(l.text=l.text+" '"+s.trim()+"'"),n.push(l)}return n}function _countMessages(e){let o=0,r=0,n=0,t=0;if(e)for(let a=0;a<e.length;++a){let i=e[a];if(i)if(void 0!==i.msgtype)switch(i.msgtype.toLowerCase()){case"error":o++;break;case"warn":case"warning":r++;break;case"info":n++;break;default:console.error("do not know message type "+i.msgtype),t++}else o++}return[o,r,n,t]}const waitForElementById=e=>new Promise(o=>{const r=()=>{const n=document.getElementById(e);n&&o(n),window.requestAnimationFrame(r)};r()}),waitForElement=(e,o)=>new Promise(r=>{const n=()=>{const t=e.querySelector(o);t&&r(t),window.requestAnimationFrame(n)};n()});function _embedErrorWithDocumentLoaded(e,o,r,n){var t=[];e=CSS.escape(e),waitForElementById(o).then(e=>waitForElement(e,"a")).then(a=>{let i=_getErrorsFromLog(o,r,n);if(0==i.length)return;const s=_countMessages(i),l=s[0],c=s[1],m=s[2],d=s[3];let p=" ";l>0&&(p+=l+'<span class="proforma-dot-icon proforma-error-icon">x</span> '),c>0&&(p+=c+'<span class="proforma-warn-icon proforma-warning"/></span> '),m>0&&(p+=m+'<span class="proforma-dot-icon proforma-info-icon">i</span> '),d>0&&(p+=d+'<span class="proforma-dot-icon proforma-else-icon">?</span> ');let f=document.createElement("button");f.type="button",f.className="proforma-feedback-msg-btn",f.innerHTML=p,a.insertAdjacentElement("afterend",f);let g=!1;f.addEventListener("click",function(){let o=_getCodeMirror("#"+e);g?(t=_hideWidgets(t),f.className="proforma-feedback-msg-btn",g=!1):(t=_showMessages(o,i,t),f.className="proforma-feedback-msg-btn active",g=!0)})}).catch(e=>{console.error(e)})}export const embedError=(e,o,r,n)=>{e?"loading"!==document.readyState?_embedErrorWithDocumentLoaded(e,o,r,n):document.addEventListener("DOMContentLoaded",function(){_embedErrorWithDocumentLoaded(e,o,r,n)}):console.error("cmid is invalid")};