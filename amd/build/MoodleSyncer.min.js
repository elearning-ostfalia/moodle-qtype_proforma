function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("qtype_proforma/MoodleSyncer",["exports","core/config","./FileViewer"],(function(_exports,_config,_FileViewer){var obj;function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.Syncer=_exports.MoodleSyncer=_exports.MoodleQuestionAttemptSyncer=void 0,_config=(obj=_config)&&obj.__esModule?obj:{default:obj};var Syncer=function(){function Syncer(options){if(_classCallCheck(this,Syncer),(this instanceof Syncer?this.constructor:void 0)===Syncer)throw new TypeError("Cannot construct Syncer instances directly");this.options=options,console.log(this.options)}return _createClass(Syncer,[{key:"deleteFileOrFolder",value:function(path){return Promise.resolve("fake implentation")}},{key:"download",value:function(path){return Promise.resolve("fake implentation")}},{key:"renameFile",value:function(pathold,pathnew){return Promise.resolve("fake implentation")}},{key:"renameFolder",value:function(pathold,pathnew){return Promise.resolve("fake implentation")}},{key:"mkdir",value:function(path){return Promise.resolve("fake implentation")}},{key:"list",value:function(framework){return Promise.resolve("fake implentation")}},{key:"update",value:function(filename,text){return Promise.resolve("fake implentation")}},{key:"newfile",value:function(filename){return Promise.resolve("fake implentation")}},{key:"upload",value:function(filename,file,overwrite){return Promise.resolve("fake implentation")}}],[{key:"splitFullname",value:function(path){var index=path.lastIndexOf("/",path.length-1);if(index<0)return["/",path];var pathname=path.substring(0,index+1);return pathname.length,[pathname,path.substring(index+1)]}}]),Syncer}();_exports.Syncer=Syncer;var MoodleQuestionAttemptSyncer=function(_Syncer){_inherits(MoodleQuestionAttemptSyncer,_Syncer);var _super=_createSuper(MoodleQuestionAttemptSyncer);function MoodleQuestionAttemptSyncer(options){return _classCallCheck(this,MoodleQuestionAttemptSyncer),_super.call(this,options)}return _createClass(MoodleQuestionAttemptSyncer,[{key:"list",value:function(framework){return this.options.files.forEach((function(path){var values=Syncer.splitFullname(path);framework.createPath(values[0]).appendFile(new _FileViewer.FileNode(values[1]))})),Promise.resolve()}},{key:"download",value:function(path){var addon="/question/response_attachments/"+this.options.usageid+"/"+this.options.slot+"/"+this.options.itemid+path,url=_config.default.wwwroot+"/pluginfile.php/"+this.options.contextid+addon;return fetch(url,{method:"GET"}).then((function(response){return response.text()})).catch((function(error){console.error("error:",error),alert(error)}))}}]),MoodleQuestionAttemptSyncer}(Syncer);_exports.MoodleQuestionAttemptSyncer=MoodleQuestionAttemptSyncer;var MoodleSyncer=function(_Syncer2){_inherits(MoodleSyncer,_Syncer2);var _super2=_createSuper(MoodleSyncer);function MoodleSyncer(options){return _classCallCheck(this,MoodleSyncer),_super2.call(this,options)}return _createClass(MoodleSyncer,[{key:"_sendRequest",value:function(action){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,url=_config.default.wwwroot+"/repository/draftfiles_ajax.php",params={};return params.sesskey=_config.default.sesskey,params.client_id=this.options.client_id,params.itemid=this.options.itemid,void 0!==options&&(params=Object.assign(params,options)),console.log("action "+action),console.log(params),fetch(url+"?action="+action+"&"+window.build_querystring(params),{method:"POST"}).then((function(response){return response.json()})).then((function(json){if(console.log("got response for requested action "+action),json.error)throw console.error(action+" error:",json.error),new Error(json.error);return console.log(json),json})).catch((function(error){console.error("error on "+action+":",error),alert(error)}))}},{key:"deleteFileOrFolder",value:function(path){console.log("delete "+path);var params={},values=MoodleSyncer.splitFullname(path);return params.filepath=values[0],params.filename=values[1],console.log("delete "+params.filepath+" "+params.filename),this._sendRequest("delete",params)}},{key:"download",value:function(path){console.log("DOWNLOAD"),console.log(this.options);var contextid=this.options.contextid,addon="/user/draft/"+this.options.itemid+path,url=_config.default.wwwroot+"/draftfile.php/"+contextid+addon;return console.log(url),fetch(url,{method:"GET"}).then((function(response){return response.text()})).catch((function(error){console.error("error:",error),alert(error)}))}},{key:"renameFile",value:function(pathold,pathnew){console.log("rename "+pathold+" => "+pathnew);var params={},values=MoodleSyncer.splitFullname(pathold),newValue=MoodleSyncer.splitFullname(pathnew);return params.filepath=values[0],params.filename=values[1],params.newfilepath=newValue[0],params.newfilename=newValue[1],this._sendRequest("updatefile",params)}},{key:"renameFolder",value:function(pathold,pathnew){console.log("rename "+pathold+" => "+pathnew);var params={},newValue=MoodleSyncer.splitFullname(pathnew);return params.filepath=pathold+"/",params.newdirname=newValue[1],params.newfilepath=newValue[0].substr(0,newValue[0].length-1),this._sendRequest("updatedir",params)}},{key:"mkdir",value:function(path){console.log("mkdir "+path);var index=path.lastIndexOf("/",path.length-1),params={};return index<0?(params.filepath="/",params.newdirname=path):(params.filepath=path.substring(0,index+1),params.newdirname=path.substring(index+1)),console.log("path = "+params.filepath),console.log("dir = "+params.newdirname),console.log(params),this._sendRequest("mkdir",params)}},{key:"list",value:function(framework){var _this=this;function stripSlashes(path){return path.length>1&&"/"===path.substring(path.length-1)&&(path=path.substring(0,path.length-1)),path}console.log("Start list");return function listfolder(path){return new Promise((function(resolve,reject){var params={};params.filepath=path,_this._sendRequest("list",params).then((function(json){var firstFile=void 0;json.list.forEach((function(item){if("."===item.filename){var _path=stripSlashes(item.filepath);console.log("Syncer: create folder "+_path),framework.createPath(_path),resolve(listfolder(_path))}else{console.log("Syncer: create file "+item.filename);var folder=framework.createPath(stripSlashes(item.filepath)),filenode=new _FileViewer.FileNode(item.filename);folder.appendFile(filenode),void 0===firstFile&&(firstFile=filenode,framework.addEditor(filenode))}})),resolve()}))}))}("/")}},{key:"update",value:function(filename,text){var async=arguments.length>2&&void 0!==arguments[2]&&arguments[2];console.log("update file "+filename);var file=new File([text],filename,{type:"text/plain"});return this.upload(filename,file,!0,async)}},{key:"newfile",value:function(filename){console.log("create new empty file "+filename);var values=Syncer.splitFullname(filename),file=new File([" "],values[1],{type:"text/plain"});return this.upload(filename,file)}},{key:"upload",value:function(filename,file){var _this2=this,overwrite=arguments.length>2&&void 0!==arguments[2]&&arguments[2],async=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],url=_config.default.wwwroot+"/repository/repository_ajax.php",action="upload";console.log("upload "+file.name+" as "+filename);var formData=new FormData;if(formData.append("sesskey",_config.default.sesskey),formData.append("repo_upload_file",file),formData.append("filepath","/"),formData.append("client_id",this.options.client_id),formData.append("title",file.name),formData.append("overwrite",overwrite),formData.append("maxbytes",this.options.maxbytes),formData.append("savepath","/"),formData.append("repo_id",this.options.repo_id),formData.append("itemid",this.options.itemid),async){var promise=fetch(url+"?action="+action,{method:"POST",body:formData}).then((function(response){return response.json()})).then((function(json){if(json.error)throw new Error(json.error);console.log(json);var originalFilename=file.name;return"/"!=originalFilename.substr(0,1)&&(originalFilename="/"+originalFilename),originalFilename!=filename?_this2.renameFile(originalFilename,filename):json})).catch((function(error){console.error("upload error:",error),alert(error)}));return promise}console.log("SYNCHRONOUSE UPDATE");var request=new XMLHttpRequest;request.open("POST",url+"?action="+action,!1),request.send(formData);var jsonResponse=JSON.parse(request.responseText);console.log(jsonResponse),void 0!==jsonResponse.error&&(console.error(request.responseText),alert(jsonResponse.error))}}]),MoodleSyncer}(Syncer);_exports.MoodleSyncer=MoodleSyncer}));

//# sourceMappingURL=MoodleSyncer.min.js.map