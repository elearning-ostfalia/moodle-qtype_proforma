function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("qtype_proforma/FileViewer",["exports","./MoodleSyncer","./codemirror-global","./codemirror","./clike","./python","./javascriptmode","./xml","./matchbrackets","./closebrackets","./active-line","core/str"],(function(_exports,_MoodleSyncer,_codemirrorGlobal,_codemirror,_clike,_python,_javascriptmode,_xml,_matchbrackets,_closebrackets,_activeLine,Str){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},_get.apply(this,arguments)}function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(self)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.RootNode=_exports.Framework=_exports.FolderNode=_exports.FileNode=void 0,_codemirror=(obj=_codemirror)&&obj.__esModule?obj:{default:obj},Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str);var TreeNode=function(){function TreeNode(name){var _this=this;_classCallCheck(this,TreeNode),this.name=name,this.element=void 0,this.parent=void 0,this.boundHandleContextMenu=function(event){if(event.preventDefault(),event.stopPropagation(),_this.setContextMenu(),void 0!==_this.getFramework().menu){var _ref,top,left,origin={left:event.pageX,top:event.pageY};top=(_ref=origin).top,left=_ref.left,_this.getFramework().menu.style.left="".concat(left,"px"),_this.getFramework().menu.style.top="".concat(top,"px"),_this.getFramework().toggleContextmenu("show")}},this.handleDragStart=function(event){0==event.dataTransfer.getData("treeitem").length&&event.dataTransfer.setData("treeitem",_this.getPath())}}var _confirmAndDo,_alreadyExists;return _createClass(TreeNode,[{key:"getPath",value:function(){return void 0===this.parent?this.name:this.parent.getPath()+"/"+this.name}},{key:"setContextMenu",value:function(){TreeNode.menu=void 0}},{key:"displayInTreeview",value:function(domnode){var li=document.createElement("li");return li.setAttribute("role","treeitem"),li.setAttribute("draggable","true"),domnode.appendChild(li),li.addEventListener("contextmenu",this.boundHandleContextMenu),li.addEventListener("dragstart",this.handleDragStart),this.element=li,li}},{key:"getFramework",value:function(){return this.parent.getFramework()}},{key:"alreadyExists",value:(_alreadyExists=_asyncToGenerator(regeneratorRuntime.mark((function _callee(name){var text;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,(0,Str.get_string)("alreadyexists","qtype_proforma",name);case 2:text=_context.sent,alert(text);case 4:case"end":return _context.stop()}}),_callee)}))),function(_x){return _alreadyExists.apply(this,arguments)})},{key:"confirmAndDo",value:(_confirmAndDo=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(prompt,callback,name){var text;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,(0,Str.get_string)(prompt,"qtype_proforma",name);case 2:text=_context2.sent,confirm(text)&&callback();case 4:case"end":return _context2.stop()}}),_callee2)}))),function(_x2,_x3,_x4){return _confirmAndDo.apply(this,arguments)})}]),TreeNode}(),FileNode=function(_TreeNode){_inherits(FileNode,_TreeNode);var _super=_createSuper(FileNode);function FileNode(name){var _this2;return _classCallCheck(this,FileNode),(_this2=_super.call(this,name)).filecontent="",_this2.mode=FileNode.getEditorModeFromFilename(_this2.name),_this2.handleDelete=function(event){_this2.getFramework().handleClick(event);var context=_assertThisInitialized(_this2);_this2.confirmAndDo("deletefile",(function(){context.getFramework().deleteEditor(context),context.getFramework().syncer.deleteFileOrFolder(context.getPath()),context.element.remove(),context.parent.files=context.parent.files.filter((function(item){return item!==context}))}),_this2.getPath())},_this2.boundHandleRename=function(event){_this2.getFramework().handleClick(event);var thecontext=_assertThisInitialized(_this2);Str.get_strings([{key:"enterfilename",component:"qtype_proforma"}]).done((function(strings){var name=prompt(strings[0]+":",thecontext.name);if(null!==name&&name.length>0){if(!thecontext.parent.isNameChildUnique(name))return void thecontext.alreadyExists(name);var oldpath=thecontext.getPath();thecontext.name=name,thecontext.element.innerHTML=name;var newpath=thecontext.getPath();thecontext.getFramework().syncer.renameFile(oldpath,newpath)}})).fail((function(response){console.error(response)}))},_this2.boundHandleClick=function(event){_this2.getFramework().toggleContextmenu("hide"),_this2.getFramework().setFocusTo(_this2.element),event.stopPropagation()},_this2.handleDoubleClick=function(event){_this2.getFramework().toggleContextmenu("hide"),null!=_this2.filecontent&&_this2.getFramework().switchEditorTo(_assertThisInitialized(_this2)),_this2.getFramework().setFocusTo(_this2.element),event.stopPropagation()},_this2}return _createClass(FileNode,[{key:"getContent",value:function(){var _this3=this;if(0==this.filecontent.length){var p1=this.getFramework().syncer.download(this.getPath());return p1.then((function(result){return _this3.filecontent=result,result})),p1}return Promise.resolve(this.filecontent)}},{key:"updateContent",value:function(newcontent,async){return this.filecontent=newcontent,this.getFramework().syncer.update(this.getPath(),newcontent,async)}},{key:"displayInTreeview",value:function(domnode){var li=_get(_getPrototypeOf(FileNode.prototype),"displayInTreeview",this).call(this,domnode);li.innerHTML=this.name,li.classList.add("doc"),li.addEventListener("dblclick",this.handleDoubleClick),li.addEventListener("click",this.boundHandleClick)}},{key:"setContextMenu",value:function(){console.log("FileNode setContextMenu");var thecontext=this;Str.get_strings([{key:"delete",component:"qtype_proforma"},{key:"rename",component:"qtype_proforma"}]).done((function(strings){thecontext.getFramework().createContextMenu([[strings[0]+"...",thecontext.handleDelete],[strings[1],thecontext.boundHandleRename]])})).fail((function(response){console.error(response)}))}}],[{key:"getEditorModeFromFilename",value:function(filename){switch(filename.split(".").pop().toLowerCase()){case"java":return"text/x-java";case"py":return"text/x-python";case"setlx":return"text/text";case"c":return"text/x-csrc";case"cpp":case"cxx":case"h":case"hpp":return"text/x-c++src";case"xml":return"application/xml";case"html":return"text/html";case"sql":return"text/x-sql";case"js":return"text/javascript";case"php":return"application/x-httpd-php";case"txt":case"log":case"md":case"csv":return"text"}}}]),FileNode}(TreeNode);_exports.FileNode=FileNode;var FolderNode=function(_TreeNode2){_inherits(FolderNode,_TreeNode2);var _super2=_createSuper(FolderNode);function FolderNode(name){var _this4;return _classCallCheck(this,FolderNode),(_this4=_super2.call(this,name)).files=[],_this4.folders=[],_this4.handleDelete=function(event){_this4.getFramework().handleClick(event);var context=_assertThisInitialized(_this4);_this4.confirmAndDo("deletefolder",(function(){context.getFramework().syncer.deleteFileOrFolder(context.getPath()+"/."),context.element.remove(),context.parent.folders=context.parent.folders.filter((function(item){return item!==context}))}),_this4.getPath())},_this4.boundHandleNewFile=function(event){_this4.getFramework().handleClick(event);var thecontext=_assertThisInitialized(_this4);Str.get_strings([{key:"enterfilename",component:"qtype_proforma"}]).done((function(strings){var filename=prompt(strings[0]+":","");if(null!==filename&&filename.length>0){if(!thecontext.isNameChildUnique(filename))return void thecontext.alreadyExists(filename);var node=new FileNode(filename);thecontext.appendFile(node),node.displayInTreeview(thecontext.element.querySelector('[role="group"]')),thecontext.expand(!0),thecontext.getFramework().syncer.newfile(node.getPath())}})).fail((function(response){console.error(response)}))},_this4.boundHandleLoadFile=function(event){_this4.getFramework().handleClick(event);var input=document.createElement("input");input.type="file",input.onchange=function(e){var file=e.target.files[0];_this4._addFileFromOs(file,!0)},input.click()},_this4.handleDragOver=function(event){event.preventDefault()},_this4.handleDragEnter=function(){_this4.getFramework().readOnly||_this4.element.querySelector(".name").classList.add("dragover")},_this4.handleDragLeave=function(){_this4.getFramework().readOnly||_this4.element.querySelector(".name").classList.remove("dragover")},_this4.handleDrop=function(event){if(event.preventDefault(),event.stopPropagation(),_this4.getFramework().toggleContextmenu("hide"),!_this4.getFramework().readOnly){_this4.element.querySelector(".name").classList.remove("dragover");var path=event.dataTransfer.getData("treeitem");if(void 0!==path&&path.length>0){console.log("drop "+path+" onto "+_this4.getPath());var node=_this4.getFramework().findNodeByPath(path);if(void 0!==node&&!_this4.isNameChildUnique(node.name))return void _this4.alreadyExists(node.name);if(node instanceof FolderNode){var oldpath=node.getPath();node.parent.folders=node.parent.folders.filter((function(item){return item!==node})),_this4.appendFolder(node),_this4.element.querySelector("ul").appendChild(node.element),_this4.expand(!0),_this4.getFramework().syncer.renameFolder(oldpath,node.getPath())}else if(node instanceof FileNode){var _oldpath=node.getPath();node.parent.files=node.parent.files.filter((function(item){return item!==node})),_this4.appendFile(node),_this4.element.querySelector("ul").appendChild(node.element),_this4.expand(!0),_this4.getFramework().syncer.renameFile(_oldpath,node.getPath())}else console.error("node cannot be moved"),console.log(node)}else{console.log("drop file/folder");for(var items=event.dataTransfer.items,i=0;i<items.length;i++){var item=items[i].webkitGetAsEntry();item&&_this4._getFileTree(item)}}}},_this4.boundHandleNewFolder=function(event){_this4.getFramework().handleClick(event);var thecontext=_assertThisInitialized(_this4);Str.get_strings([{key:"enterfoldername",component:"qtype_proforma"}]).done((function(strings){var foldername=prompt(strings[0]+":","");if(null!==foldername&&foldername.length>0){if(!thecontext.isNameChildUnique(foldername))return void thecontext.alreadyExists(foldername);var node=new FolderNode(foldername);thecontext.appendFolder(node),node.displayInTreeview(thecontext.element.querySelector('[role="group"]')),thecontext.expand(!0),console.log("create new folder "+node.getPath()),thecontext.getFramework().syncer.mkdir(node.getPath())}})).fail((function(response){console.error(response)}))},_this4.boundHandleClick=function(event){console.log("FolderNode click"),_this4.getFramework().toggleContextmenu("hide"),_this4.getFramework().setFocusTo(_this4.element),event.stopPropagation(),event.preventDefault()},_this4.boundHandleRename=function(event){_this4.getFramework().handleClick(event);var thecontext=_assertThisInitialized(_this4);Str.get_strings([{key:"enterfoldername",component:"qtype_proforma"}]).done((function(strings){var name=prompt(strings[0]+":",thecontext.name);if(null!==name&&name.length>0){if(!thecontext.parent.isNameChildUnique(name))return void thecontext.alreadyExists(name);var oldpath=thecontext.getPath()+"/.";thecontext.name=name,thecontext.element.querySelector(".name").innerHTML=name;var newpath=thecontext.getPath()+"/.";thecontext.getFramework().syncer.renameFolder(oldpath,newpath)}})).fail((function(response){console.error(response)}))},_this4.toggleExpand=function(){_this4.element.setAttribute("aria-expanded",!_this4.isExpanded())},_this4.handleMouseOver=function(event){event.currentTarget.classList.add("hover")},_this4.handleMouseOut=function(event){event.currentTarget.classList.remove("hover")},_this4}return _createClass(FolderNode,[{key:"findNodeByPath",value:function(path){for(var first=path.shift(),i=0;i<this.files.length;i++)if(this.files[i].name===first)return this.files[i];for(var _i=0;_i<this.folders.length;_i++)if(this.folders[_i].name===first)return 0==path.length?this.folders[_i]:this.folders[_i].findNodeByPath(path)}},{key:"createPath",value:function(path){var first=path.shift();if(void 0===first||0==first.length)return path.lenghth>0&&console.error("Bug in creating path"),this;for(var i=0;i<this.folders.length;i++)if(this.folders[i].name===first)return 0==path.length?this.folders[i]:this.folders[i].createPath(path);var node=new FolderNode(first);return this.appendFolder(node),node.createPath(path)}},{key:"isNameChildUnique",value:function(name){for(var i=0;i<this.files.length;i++)if(0==name.localeCompare(this.files[i].name))return!1;for(var _i2=0;_i2<this.folders.length;_i2++)if(0==name.localeCompare(this.folders[_i2].name))return!1;return!0}},{key:"_getFileTree",value:function(item){var _this5=this,path=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,recurseinit=void 0===path;path=path||"",item.isFile?item.file((function(file){_this5._addFileFromOs(file,recurseinit)})):item.isDirectory}},{key:"_addFileFromOs",value:function(file){var _this6=this,show=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.isNameChildUnique(file.name)){var node=new FileNode(file.name),reader=new FileReader;reader.readAsText(file,"UTF-8"),reader.onload=function(readerEvent){var content=readerEvent.target.result;node.filecontent=content,show&&(_this6.getFramework().addEditor(node),_this6.getFramework().setFocusTo(node.element)),_this6.getFramework().syncer.upload(node.getPath(),file)},this.appendFile(node),node.displayInTreeview(this.element.querySelector('[role="group"]')),this.expand(!0)}else this.alreadyExists(file.name)}},{key:"expand",value:function(doit){this.element.setAttribute("aria-expanded",doit)}},{key:"displayInTreeview",value:function(domnode){var li=_get(_getPrototypeOf(FolderNode.prototype),"displayInTreeview",this).call(this,domnode);li.setAttribute("aria-expanded","false");var span2=document.createElement("span");span2.addEventListener("dblclick",this.toggleExpand),span2.innerHTML=this.name,span2.classList.add("name"),span2.addEventListener("click",this.boundHandleClick),span2.addEventListener("dragenter",this.handleDragEnter),span2.addEventListener("dragleave",this.handleDragLeave),span2.addEventListener("drop",this.handleDrop),span2.addEventListener("dragover",this.handleDragOver),li.appendChild(span2);var subul=document.createElement("ul");subul.setAttribute("role","group"),li.appendChild(subul);for(var j=0;j<this.folders.length;j++)this.folders[j].displayInTreeview(subul);for(var _j=0;_j<this.files.length;_j++)this.files[_j].displayInTreeview(subul)}},{key:"isExpanded",value:function(){return"true"===this.element.getAttribute("aria-expanded")}},{key:"setContextMenu",value:function(){console.log("FolderNode setContextMenu");var thecontext=this;Str.get_strings([{key:"newemptyfile",component:"qtype_proforma"},{key:"loadfile",component:"qtype_proforma"},{key:"newfolder",component:"qtype_proforma"},{key:"rename",component:"qtype_proforma"},{key:"delete",component:"qtype_proforma"}]).done((function(strings){thecontext.getFramework().createContextMenu([[strings[0]+"...",thecontext.boundHandleNewFile],[strings[1]+"...",thecontext.boundHandleLoadFile],[strings[3],thecontext.boundHandleRename],[strings[4]+"...",thecontext.handleDelete]])})).fail((function(response){console.error(response)}))}},{key:"appendFile",value:function(node){this.files.push(node),node.parent=this}},{key:"appendFolder",value:function(node){this.folders.push(node),node.parent=this}}]),FolderNode}(TreeNode);_exports.FolderNode=FolderNode;var RootNode=function(_FolderNode){_inherits(RootNode,_FolderNode);var _super3=_createSuper(RootNode);function RootNode(name,framework){var _this7;return _classCallCheck(this,RootNode),_this7=_super3.call(this,name),console.log("CREATE root node "+name),_this7.framework=framework,framework.roots.push(_assertThisInitialized(_this7)),_this7}return _createClass(RootNode,[{key:"getFramework",value:function(){return this.framework}},{key:"getPath",value:function(){return""}},{key:"setContextMenu",value:function(){console.log("RootNode setContextMenu");var thecontext=this;Str.get_strings([{key:"newemptyfile",component:"qtype_proforma"},{key:"loadfile",component:"qtype_proforma"},{key:"newfolder",component:"qtype_proforma"}]).done((function(strings){thecontext.getFramework().createContextMenu([[strings[0]+"...",thecontext.boundHandleNewFile],[strings[1]+"...",thecontext.boundHandleLoadFile]])})).fail((function(response){console.error(response)}))}}]),RootNode}(FolderNode);_exports.RootNode=RootNode;var EditorItem=_createClass((function EditorItem(fileNode,textarea,tabDomNode,readOnly){_classCallCheck(this,EditorItem),console.log("Create Codemirror "+readOnly),this.fileNode=fileNode,this.editor=_codemirror.default.fromTextArea(textarea,{tabMode:"indent",indentUnit:4,matchBrackets:!0,autoCloseBrackets:!0,styleActiveLine:!0,readOnly:readOnly,extraKeys:{Tab:function(){this.editor.replaceSelection("    ","end")}},lineNumbers:!0}),this.editor.setSize("100%","100%"),this.editor.setOption("theme","darcula"),this.tab=tabDomNode})),EditorStack=function(){function EditorStack(donNodeEditor,donNodeTabs,framework){_classCallCheck(this,EditorStack),this.editortextarea=donNodeEditor.querySelector("textarea"),this.editor=_codemirror.default.fromTextArea(this.editortextarea,{tabMode:"indent",indentUnit:4,matchBrackets:!0,autoCloseBrackets:!0,styleActiveLine:!0,readOnly:!0,extraKeys:{Tab:function(){this.editor.replaceSelection("    ","end")}},lineNumbers:!0}),this.editor.setSize("100%","100%"),this.editor.setOption("theme","darcula"),this.activeNode=void 0,this.nodes=[],this.donNodeTabs=donNodeTabs,this.focus=void 0,this.framework=framework}return _createClass(EditorStack,[{key:"_switchTo",value:function(item){var index=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;if(void 0===index)for(index=0;index<this.nodes.length&&this.nodes[index]!==item;index++);for(console.log("item index is "+index),this.nodes.splice(index,1),this.nodes.push(item),index=0;index<this.nodes.length;index++)this.nodes[index].editor.getWrapperElement().style.display="none";if(item.editor.getWrapperElement().style.display="block",item.editor.refresh(),item.editor.focus(),void 0!==this.focus){this.focus.classList.remove("focus");var focusClose=this.focus.querySelector(".close");focusClose.style.display="none"}item.tab.classList.add("focus"),item.tab.querySelector(".close").style.display="inline",this.focus=item.tab}},{key:"_delete",value:function(item){for(var i=0;i<this.nodes.length;i++)if(this.nodes[i]===item)return console.log("** Delete item from editor"),this.nodes[i].fileNode.updateContent(this.nodes[i].editor.getValue()),this.nodes.splice(i,1),item.editor.getWrapperElement().remove(),void(this.nodes.length>0&&this._switchTo(this.nodes[this.nodes.length-1],this.nodes.length-1));console.error("could not find filenode")}},{key:"deleteEditor",value:function(filenode){for(var i=0;i<this.nodes.length;i++)if(this.nodes[i].fileNode===filenode)return this.nodes[i].tab.remove(),this.nodes[i].tab=void 0,void this._delete(this.nodes[i])}},{key:"addEditor",value:function(filenode){var _this8=this;if(EditorStack.maxEditors!=this.nodes.length)if(void 0!==filenode.mode){var tab=document.createElement("button"),item=new EditorItem(filenode,this.editortextarea,tab,this.framework.readOnly);filenode.getContent().then((function(text){void 0===text&&(text="???"),item.editor.setValue(text),item.editor.setOption("mode",filenode.mode),item.editor.refresh()})).catch((function(error){console.error("error:",error),alert(error)})),tab.classList.add("tab");var close=document.createElement("span");close.classList.add("close"),close.innerHTML="&#x2715",close.addEventListener("click",(function(event){event.preventDefault(),event.stopPropagation(),_this8._delete(item),close.parentElement.remove()})),tab.innerHTML=filenode.name,tab.append(close),tab.addEventListener("click",(function(event){event.preventDefault(),event.stopPropagation(),_this8._switchTo(item)})),this.donNodeTabs.append(tab),this.nodes.push(item),this._switchTo(item)}else console.error("unknown file mode");else alert("maximum number of editors reached")}},{key:"switchEditorTo",value:function(filenode){for(var i=0;i<this.nodes.length;i++)if(this.nodes[i].fileNode===filenode)return void this._switchTo(this.nodes[i],i);this.addEditor(filenode)}},{key:"handleResize",value:function(){this.nodes.length>0&&this.nodes[this.nodes.length-1].editor.refresh()}},{key:"save",value:function(){console.log("currently open editors "+this.nodes.length.toString()),console.timeStamp("save"),console.time("save");for(var i=0;i<this.nodes.length;i++)this.nodes[i].fileNode.updateContent(this.nodes[i].editor.getValue(),!1);console.log("all files saved"),console.timeStamp("save"),console.timeEnd("save")}}]),EditorStack}();_defineProperty(EditorStack,"maxEditors",12);var Framework=function(){function Framework(){var _this9=this;_classCallCheck(this,Framework),_defineProperty(this,"toggleContextmenu",(function(command){void 0!==_this9.menu&&(_this9.menu.style.display="show"===command?"block":"none",_this9.menuVisible="show"===command)})),this.roots=[],this.syncer=void 0,this.editorstack=void 0,this.mainDomNode=void 0,this.menu=void 0,this.menuVisible=!1,this.focus=void 0,this.readOnly=!1,this.rootnode="Submission"}return _createClass(Framework,[{key:"buildFramework",value:function(domnode){console.log("buildFramework"),domnode.innerHTML='<div class="ide" style="display: flex;flex-direction: column; align-items: stretch;\n    resize: vertical;\n    overflow: hidden;\n    min-height: 150px">\n    \x3c!--<div class="menu" style="flex: none">menu</div>--\x3e\n\n    <div class="body" style="display: flex; flex-direction: row; flex: 1 1 0; min-height: 0">\n        \x3c!--<div class="fake" style="min-width: 100px; flex: 1 0 0; overflow: auto;">Fake element</div> --\x3e\n        <div class="explorer" style="min-width: 20px; flex: 1 0 0; overflow: auto;">\n        </div>\n        <div class="resize"></div>\n        <div class="canvas" style="min-width: 20px;  flex: 0 0 75%; display: flex; flex-direction: row;">\n            \x3c!-- set flex-basis = 50% for 2 two columns and 100%V for one column --\x3e\n            <div class="canvascol" style="display: flex; flex-direction: column; flex: 1 1 50%; overflow: hidden;">\n                <div class="tabs" style="flex: none; ">\n                </div>\n                <div class="editor" style="flex: 1 1 0; overflow: hidden;">\n                    <textarea></textarea>\n                </div>\n            </div>\n            \x3c!--\n            <div class="resize"></div>\n            <div class="canvascol" style="display: flex; flex-direction: column; flex: 1 1 50%; min-height: 0;">\n                <div class="tabs" style="flex: none; ">\n                </div>\n                <div class="editor" style="flex: 1 1 0; min-height: 0; overflow: hidden;">\n                    <textarea></textarea>\n                </div>\n            </div> --\x3e \n        </div>\n    </div>\n\n    \x3c!--<div class="status" style="flex: none">status</div>--\x3e\n</div>\n<p>\x3c!--<label>File or Folder Selected: <input id="last_action" type="text" size="15" readonly=""></label>--\x3e</p>\n';var menu=document.createElement("div");menu.innerHTML='<div class="contextmenu" id="context-menu">\n    <ul class="menu-options">\n        <li class="menu-option">New file</li>\n        <li class="menu-option">New folder</li>\n        <li class="menu-option">Delete...</li>\n    </ul>\n</div>',document.querySelector("body").appendChild(menu),this.mainDomNode=domnode,this.editorstack=new EditorStack(domnode.querySelector(".editor"),domnode.querySelector(".tabs"),this)}},{key:"init",value:function(node,syncer,readOnly){var _this10=this,rootnode=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"Files";this.readOnly=readOnly,this.rootnode=rootnode;var initSplit=function(resizer){var before=resizer.previousElementSibling,after=resizer.nextElementSibling,x=0,oldValue=0,mousedown=!1,removeSelection=function(){resizer.style.removeProperty("cursor"),document.body.style.removeProperty("cursor"),before.style.removeProperty("user-select"),before.style.removeProperty("pointer-events"),null!=after&&(after.style.removeProperty("user-select"),after.style.removeProperty("pointer-events"))},mouseMoveHandler=function(e){if(mousedown){var dx=e.clientX-x,newBasis=100*(oldValue+dx)/resizer.parentNode.getBoundingClientRect().width;before.style.flexBasis="".concat(newBasis,"%"),null!=after?after.style.flexBasis="".concat(100-newBasis,"%"):resizer.parentNode.getBoundingClientRect().width=resizer.parentNode.getBoundingClientRect().width-dx,removeSelection()}else mouseUpHandler()},mouseUpHandler=function mouseUpHandler(){removeSelection(),document.removeEventListener("mousemove",mouseMoveHandler),document.removeEventListener("mouseup",mouseUpHandler)};resizer.addEventListener("mousedown",(function(e){x=e.clientX,_this10.toggleContextmenu("hide"),oldValue=before.getBoundingClientRect().width,mousedown=!0,document.addEventListener("mousemove",mouseMoveHandler),document.addEventListener("mouseup",mouseUpHandler),removeSelection()}))},fileviewer=node.querySelector(".explorer");fileviewer.addEventListener("drop",(function(event){event.preventDefault()})),fileviewer.addEventListener("dragover",(function(event){event.preventDefault()}));var ul=document.createElement("ul");ul.setAttribute("role","tree"),ul.setAttribute("aria-labelledby","fileviewer"),fileviewer.appendChild(ul),this.syncer=syncer,this.createPath("/"),this.syncer.list(this).then((function(){console.log("DISPLAY ROOTS"),console.log(_this10.roots);for(var i=0;i<_this10.roots.length;i++){var root=_this10.roots[i];root.displayInTreeview(ul),root.toggleExpand()}})),window.addEventListener("click",(function(e){_this10.handleClick()}));var el=this.mainDomNode.querySelector(".ide"),observer=new ResizeObserver((function(){_this10.editorstack.handleResize()}));observer.observe(el),initSplit(node.querySelector(".ide .body > .resize"),"w")}},{key:"switchEditorTo",value:function(filenode){this.editorstack.switchEditorTo(filenode)}},{key:"addEditor",value:function(filenode){this.editorstack.addEditor(filenode)}},{key:"deleteEditor",value:function(filenode){this.editorstack.deleteEditor(filenode)}},{key:"findNodeByPath",value:function(path){if(console.log("find <"+path+">"),"/"==path.substr(0,1)){var pathsplit=path.split("/");return pathsplit.shift(),this.roots[0].findNodeByPath(pathsplit)}console.error("path does not start with /: "+path)}},{key:"createPath",value:function(path){console.log("Framework: create folder "+path),"/"!==path[0]&&console.error("first char in path is not /: "+path);var pathsplit=path.split("/");pathsplit.shift();return 0===this.roots.length?new RootNode(this.rootnode,this).createPath(pathsplit):this.roots[0].createPath(pathsplit)}},{key:"createContextMenu",value:function(list){if(!this.readOnly){console.log("createContextMenu "+list.length);var ul=document.querySelector(".contextmenu .menu-options");ul.innerHTML="";for(var i=0;i<list.length;i++){var li=document.createElement("li");li.setAttribute("class","menu-option"),li.innerHTML=list[i][0],li.addEventListener("click",list[i][1]),console.log(list[i][0]),ul.appendChild(li)}this.menu=ul.parentNode}}},{key:"handleClick",value:function(){this.toggleContextmenu("hide"),this.setFocusTo(void 0)}},{key:"setFocusTo",value:function(element){void 0!==this.focus&&this.focus.classList.remove("focus"),void 0!==element?(element.classList.add("focus"),this.focus=element):this.focus=void 0}},{key:"save",value:function(){return console.log(this),console.log(this.editorstack),this.editorstack.save()}}]),Framework}();_exports.Framework=Framework}));

//# sourceMappingURL=FileViewer.min.js.map