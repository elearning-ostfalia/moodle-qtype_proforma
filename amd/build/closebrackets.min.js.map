{"version":3,"file":"closebrackets.min.js","sources":["../src/closebrackets.js"],"sourcesContent":["// CodeMirror, copyright (c) by Marijn Haverbeke and others\n// Distributed under an MIT license: https://codemirror.net/LICENSE\n\n(function(mod) {\n  if (typeof exports == \"object\" && typeof module == \"object\") // CommonJS\n    mod(require(\"qtype_proforma/codemirror\"));\n  else if (typeof define == \"function\" && define.amd) // AMD\n    define([\"qtype_proforma/codemirror\"], mod);\n  else // Plain browser env\n    mod(CodeMirror);\n})(function(CodeMirror) {\n  var defaults = {\n    pairs: \"()[]{}''\\\"\\\"\",\n    closeBefore: \")]}'\\\":;>\",\n    triples: \"\",\n    explode: \"[]{}\"\n  };\n\n  var Pos = CodeMirror.Pos;\n\n  CodeMirror.defineOption(\"autoCloseBrackets\", false, function(cm, val, old) {\n    if (old && old != CodeMirror.Init) {\n      cm.removeKeyMap(keyMap);\n      cm.state.closeBrackets = null;\n    }\n    if (val) {\n      ensureBound(getOption(val, \"pairs\"))\n      cm.state.closeBrackets = val;\n      cm.addKeyMap(keyMap);\n    }\n  });\n\n  function getOption(conf, name) {\n    if (name == \"pairs\" && typeof conf == \"string\") return conf;\n    if (typeof conf == \"object\" && conf[name] != null) return conf[name];\n    return defaults[name];\n  }\n\n  var keyMap = {Backspace: handleBackspace, Enter: handleEnter};\n  function ensureBound(chars) {\n    for (var i = 0; i < chars.length; i++) {\n      var ch = chars.charAt(i), key = \"'\" + ch + \"'\"\n      if (!keyMap[key]) keyMap[key] = handler(ch)\n    }\n  }\n  ensureBound(defaults.pairs + \"`\")\n\n  function handler(ch) {\n    return function(cm) { return handleChar(cm, ch); };\n  }\n\n  function getConfig(cm) {\n    var deflt = cm.state.closeBrackets;\n    if (!deflt || deflt.override) return deflt;\n    var mode = cm.getModeAt(cm.getCursor());\n    return mode.closeBrackets || deflt;\n  }\n\n  function handleBackspace(cm) {\n    var conf = getConfig(cm);\n    if (!conf || cm.getOption(\"disableInput\")) return CodeMirror.Pass;\n\n    var pairs = getOption(conf, \"pairs\");\n    var ranges = cm.listSelections();\n    for (var i = 0; i < ranges.length; i++) {\n      if (!ranges[i].empty()) return CodeMirror.Pass;\n      var around = charsAround(cm, ranges[i].head);\n      if (!around || pairs.indexOf(around) % 2 != 0) return CodeMirror.Pass;\n    }\n    for (var i = ranges.length - 1; i >= 0; i--) {\n      var cur = ranges[i].head;\n      cm.replaceRange(\"\", Pos(cur.line, cur.ch - 1), Pos(cur.line, cur.ch + 1), \"+delete\");\n    }\n  }\n\n  function handleEnter(cm) {\n    var conf = getConfig(cm);\n    var explode = conf && getOption(conf, \"explode\");\n    if (!explode || cm.getOption(\"disableInput\")) return CodeMirror.Pass;\n\n    var ranges = cm.listSelections();\n    for (var i = 0; i < ranges.length; i++) {\n      if (!ranges[i].empty()) return CodeMirror.Pass;\n      var around = charsAround(cm, ranges[i].head);\n      if (!around || explode.indexOf(around) % 2 != 0) return CodeMirror.Pass;\n    }\n    cm.operation(function() {\n      var linesep = cm.lineSeparator() || \"\\n\";\n      cm.replaceSelection(linesep + linesep, null);\n      cm.execCommand(\"goCharLeft\");\n      ranges = cm.listSelections();\n      for (var i = 0; i < ranges.length; i++) {\n        var line = ranges[i].head.line;\n        cm.indentLine(line, null, true);\n        cm.indentLine(line + 1, null, true);\n      }\n    });\n  }\n\n  function contractSelection(sel) {\n    var inverted = CodeMirror.cmpPos(sel.anchor, sel.head) > 0;\n    return {anchor: new Pos(sel.anchor.line, sel.anchor.ch + (inverted ? -1 : 1)),\n            head: new Pos(sel.head.line, sel.head.ch + (inverted ? 1 : -1))};\n  }\n\n  function handleChar(cm, ch) {\n    var conf = getConfig(cm);\n    if (!conf || cm.getOption(\"disableInput\")) return CodeMirror.Pass;\n\n    var pairs = getOption(conf, \"pairs\");\n    var pos = pairs.indexOf(ch);\n    if (pos == -1) return CodeMirror.Pass;\n\n    var closeBefore = getOption(conf,\"closeBefore\");\n\n    var triples = getOption(conf, \"triples\");\n\n    var identical = pairs.charAt(pos + 1) == ch;\n    var ranges = cm.listSelections();\n    var opening = pos % 2 == 0;\n\n    var type;\n    for (var i = 0; i < ranges.length; i++) {\n      var range = ranges[i], cur = range.head, curType;\n      var next = cm.getRange(cur, Pos(cur.line, cur.ch + 1));\n      if (opening && !range.empty()) {\n        curType = \"surround\";\n      } else if ((identical || !opening) && next == ch) {\n        if (identical && stringStartsAfter(cm, cur))\n          curType = \"both\";\n        else if (triples.indexOf(ch) >= 0 && cm.getRange(cur, Pos(cur.line, cur.ch + 3)) == ch + ch + ch)\n          curType = \"skipThree\";\n        else\n          curType = \"skip\";\n      } else if (identical && cur.ch > 1 && triples.indexOf(ch) >= 0 &&\n                 cm.getRange(Pos(cur.line, cur.ch - 2), cur) == ch + ch) {\n        if (cur.ch > 2 && /\\bstring/.test(cm.getTokenTypeAt(Pos(cur.line, cur.ch - 2)))) return CodeMirror.Pass;\n        curType = \"addFour\";\n      } else if (identical) {\n        var prev = cur.ch == 0 ? \" \" : cm.getRange(Pos(cur.line, cur.ch - 1), cur)\n        if (!CodeMirror.isWordChar(next) && prev != ch && !CodeMirror.isWordChar(prev)) curType = \"both\";\n        else return CodeMirror.Pass;\n      } else if (opening && (next.length === 0 || /\\s/.test(next) || closeBefore.indexOf(next) > -1)) {\n        curType = \"both\";\n      } else {\n        return CodeMirror.Pass;\n      }\n      if (!type) type = curType;\n      else if (type != curType) return CodeMirror.Pass;\n    }\n\n    var left = pos % 2 ? pairs.charAt(pos - 1) : ch;\n    var right = pos % 2 ? ch : pairs.charAt(pos + 1);\n    cm.operation(function() {\n      if (type == \"skip\") {\n        cm.execCommand(\"goCharRight\");\n      } else if (type == \"skipThree\") {\n        for (var i = 0; i < 3; i++)\n          cm.execCommand(\"goCharRight\");\n      } else if (type == \"surround\") {\n        var sels = cm.getSelections();\n        for (var i = 0; i < sels.length; i++)\n          sels[i] = left + sels[i] + right;\n        cm.replaceSelections(sels, \"around\");\n        sels = cm.listSelections().slice();\n        for (var i = 0; i < sels.length; i++)\n          sels[i] = contractSelection(sels[i]);\n        cm.setSelections(sels);\n      } else if (type == \"both\") {\n        cm.replaceSelection(left + right, null);\n        cm.triggerElectric(left + right);\n        cm.execCommand(\"goCharLeft\");\n      } else if (type == \"addFour\") {\n        cm.replaceSelection(left + left + left + left, \"before\");\n        cm.execCommand(\"goCharRight\");\n      }\n    });\n  }\n\n  function charsAround(cm, pos) {\n    var str = cm.getRange(Pos(pos.line, pos.ch - 1),\n                          Pos(pos.line, pos.ch + 1));\n    return str.length == 2 ? str : null;\n  }\n\n  function stringStartsAfter(cm, pos) {\n    var token = cm.getTokenAt(Pos(pos.line, pos.ch + 1))\n    return /\\bstring/.test(token.type) && token.start == pos.ch &&\n      (pos.ch == 0 || !/\\bstring/.test(cm.getTokenTypeAt(pos)))\n  }\n});\n"],"names":["mod","CodeMirror","defaults","pairs","closeBefore","triples","explode","Pos","getOption","conf","name","_typeof","defineOption","cm","val","old","Init","removeKeyMap","keyMap","state","closeBrackets","ensureBound","addKeyMap","Backspace","getConfig","Pass","ranges","listSelections","i","length","empty","around","charsAround","head","indexOf","cur","replaceRange","line","ch","Enter","operation","linesep","lineSeparator","replaceSelection","execCommand","indentLine","chars","charAt","key","handler","pos","type","identical","opening","curType","range","next","getRange","test","getTokenTypeAt","prev","isWordChar","stringStartsAfter","left","right","sels","getSelections","replaceSelections","slice","contractSelection","setSelections","triggerElectric","handleChar","deflt","override","getModeAt","getCursor","sel","inverted","cmpPos","anchor","str","token","getTokenAt","start","exports","module","require","define","amd"],"mappings":"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"}